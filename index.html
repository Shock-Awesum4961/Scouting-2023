<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="canonical" href="https://shock-awesum4961.github.io/Scouting-2023/" />

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="manifest" href="src/manifest.json">
    <meta name="apple-mobile-web-app-status-bar" content="#db4938">
    <meta name="theme-color" content="#db4938">
    <title>4961 Scouting</title>
  </head>
  <body>
    <main>
      <div class="main-container">
        <nav>
          <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button" aria-controls="offcanvasExample">
            <img src="/images/icons/menu-bars.svg"/>
          </a>
          <!-- <div class="nav nav-tabs w-100 nav-fill justify-content-center" id="nav-tab" role="tablist">
            <a class="nav-link nav-fill active" id="nav-home-tab" type="button" role="tab" aria-selected="true">Home</a>
            <a class="nav-link nav-fill " id="nav-record-tab" type="button" role="tab" aria-controls="nav-record" aria-selected="false" disabled href="pages/match-scouting.html">Match Scout</a>
            <a class="nav-link nav-fill " id="nav-pit-tab" data-bs-toggle="tab" data-bs-target="#nav-pit" type="button" role="tab" aria-controls="nav-pit" aria-selected="false" disabled href="pages/pit-scouting.html">Pit Scout</a>
            <a class="nav-link nav-fill " id="nav-matches-tab" data-bs-toggle="tab" data-bs-target="#nav-matches" type="button" role="tab" aria-controls="nav-matches" aria-selected="false">Saved</a>
            <a class="nav-link nav-fill " id="nav-transfer-tab" data-bs-toggle="tab" data-bs-target="#nav-transfer" type="button" role="tab" aria-controls="nav-transfer" aria-selected="false" >Transfer</a>
            <button class="nav-link nav-fill " id="nav-analyze-tab" data-bs-toggle="tab" data-bs-target="#nav-analyze" type="button" role="tab" aria-controls="nav-analyze" aria-selected="false" >Analyze</button>
          </div> -->
        </nav>
        <div class="container">
          <div class="tab-content" id="nav-tabContent">
            <!-- Home Tab -->
            <div class="tab-pane show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0">
              <div class=" mt-4">
                <h4 type="text" class="text-secondary text-center">4961 Scouting 2023</h4>
              </div>
              <div class="mt-4 mx-auto"style="width:70%">
                <input type="text" class="form-control" placeholder="Name (Required)" aria-label="Name" id="scout_name">
              </div>
              <div class=" mt-4 d-flex justify-content-around">
                <a class="btn btn-primary btn-lg" id="startScouting" disabled href="pages/match-scouting.html">Match Scouting</a>
                <button class="btn btn-success btn-lg" onclick="$('#nav-pit-tab' ).trigger('click');saveScoutName();" id="pitScouting" disabled>Pit Scouting</button>
              </div>
            </div>
            <!-- Saved Tab -->
            <div class="tab-pane " id="nav-matches" role="tabpanel" aria-labelledby="nav-matches-tab" tabindex="0">
              <div class="mt-4">
                <h4>Saved Matches</h4>
                <div class="list-group mt-4" id="savedMatchesList">
              </div>
              </div>
            </div>

            <!-- Transfer Tab -->
            <div class="tab-pane " id="nav-transfer" role="tabpanel" aria-labelledby="nav-transfer-tab" tabindex="0">
              <div class="btn-group w-100 mt-2" role="group" aria-label="Basic radio toggle button group" id="transfer_choice">
                <input type="radio" class="btn-check" name="transfer_choice" id="transfer_send" value="Send" autocomplete="off" checked>
                <label class="btn btn-outline-danger  flex-fill " for="transfer_send">Send</label>
                <input type="radio" class="btn-check" name="transfer_choice" id="transfer_receive" value="Receive" autocomplete="off">
                <label class="btn btn-outline-danger flex-fill " for="transfer_receive">Receive</label>
              </div>
              <div class="send-data-section mt-2" id="send-data-section">
                <div class="d-flex justify-content-between">
                  <div class="w-100 pe-2">
                    <div class="btn-group w-100" role="group" aria-label="Basic radio toggle button group" id="send_choice">
                      <input type="radio" class="btn-check" name="send_choice" id="transfer_send_matches" value="SendMatches" autocomplete="off" checked>
                      <label class="btn btn-outline-primary  flex-fill " for="transfer_send_matches">Matches</label>
                      <input type="radio" class="btn-check" name="send_choice" id="transfer_send_pits" value="SendPits" autocomplete="off">
                      <label class="btn btn-outline-primary flex-fill " for="transfer_send_pits">Pits</label>
                    </div>
                    <div id="send-list-section">
                      <div class="send-matches-section" id="send-matches-section">
                        <h4>Matches Needing Transfer</h4>
                        <div class="list-group mt-4 text-left" id="sendSavedMatchesList"></div>
                      </div>
                      <div class="send-pits-section" style="display:none!important" id="send-pits-section">
                        <h4>Pit Info Needing Transfer</h4>
                        <div class="list-group mt-4 text-left" id="sendSavedPitsList"></div>
                      </div>
                    </div>
                    <div class="mt-4 text-center" id="qrCodeSection" style="display:none;">
                      <!-- <button class="btn btn-primary" onClick="generateQRCode('qrCodeBlock',{name:'test'})">Generate test QR Code</button> -->
                      <div class="text-center mt-2" id="qrCodeBlock">

                      </div>
                      <div class="text-center my-2" id="numTransferInfo" style="display:none!important">
                        <div class=" d-flex justify-content-around ">
                          <div><button class="btn btn-primary" id="qrPrevBtn" style="display:none">Prev</button></div>
                          <div>QR Code (<span id="currentQrCode"></span> of <span id="numQrCodes"></span>)</div>
                          <div><button class="btn btn-primary" id="qrNextBtn">Next</button></div>
                        </div>
                      </div>
                    </div>
                    <div class="text-center d-flex flex-end mt-2">
                      <button class="btn btn-primary" onClick="backToSelectTransfer()"  id="generateQrCodeBackBtn" style="display:none;">Back</button>
                      <button class="btn btn-danger ms-auto" id="doneTransferBtn" style="display:none">Finished</button>
                      <button class="btn btn-primary ms-auto" onClick="showQRCodeForMatches()"  id="generateQrCodeBtn" disabled>Generate QR Code</button>
                    </div>
                  </div>
                </div>

              </div>
              <div class="recieve-data-section mt-4 text-center" id="receive-data-section" style="display:none">
                Receive
                <button class="btn btn-primary" id="initCameraScanning">Start Scanning</button>
                <button class="btn btn-primary" id="stopCameraScanning">Stop Scanning</button>
                <div id="reader"  width="20rem" height="20rem"></div>
              </div>

            </div>

            <div class="tab-pane" id="nav-analyze" role="tabpanel" aria-labelledby="nav-analyze-tab" tabindex="0">
              <div>
                Analyze Data  
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          <h5 class="offcanvas-title" id="offcanvasExampleLabel">4961 Scouting</h5>
        </div>
        <div class="offcanvas-body">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="/index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/match-scouting.html">Match Scouting</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/pit-scouting.html">Pit Scouting</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="/pages/saved.html">Disabled</a>
            </li>
          </ul>s="list-group-item">And a fifth one</li>
          </ul>
          <!-- <div>
            Some text as placeholder. In real life you can have the elements you have chosen. Like, text, images, lists, etc.
          </div>
          <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
              Dropdown button
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
          </div> -->
        </div>
      </div>
    </main>
    
    <script src="js/jquery-3.6.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/umd.js"></script>
    <script src="js/qrcode.js"></script>
    <script src="js/html5-qrcode.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/database.js"></script>
    <script src="js/helper.js"></script>

    <!-- Current Match data -->
    <script>

      $().ready(function(){
        $('#scout_name').val(getCookie('scout_name') || '');
        $('#matchType').val(getCookie('matchType') || '');
        validateScoutName()

        initData()
      });

      function validateScoutName(){
        if($('#scout_name').val() !== "" && $('#scout_name').val() !== null){
          $('#startScouting').prop('disabled', false);
          $('#pitScouting').prop('disabled', false);
          $('#nav-record-tab').prop('disabled', false);
          $('#nav-pit-tab').prop('disabled', false);
        }
      }

      $('#scout_name').on('keyup', function(){
        validateScoutName()
      });

      $('#scout_name').change(function(){
        validateScoutName()
        setCookie('scout_name', $('#scout_name').val(), 4);
        
      });


    </script>

    <!--Pit Scouting -->
    <script>
      $('#pitDrivetrain').change(function(){
        if($('#pitDrivetrain').val() == "other"){
          $('#otherDrivetrain').show()
        } else{
          $('#otherDrivetrain').hide()
          
        }
      })

      $('#pitScoutingForm').submit(function(event){
        event.preventDefault();
        if($('#pitTeamNumber').val() == ""){alert("Enter a team number");return;}
        let value = $(('#pitScoutingForm')).serializeArray();
        value.push({name:"pitComments",value:$('#pitComments').val()});
        value.push({name:"recorded_date",value:new Date()});
        value.push({name:"type",value:"pit"});
        addPit(value);
        resetPitScout();
      });

      function resetPitScout(){
        $('#pitScoutingForm')[0].reset();
      }

      $('#transfer_send_pits').click(function(){
        $('#send-pits-section').show();
        $('#send-matches-section').hide();
      })

      $('#transfer_send_matches').click(function(){
        $('#send-matches-section').show();
        $('#send-pits-section').hide();
      })
    </script>

    <!-- All Timings & UI Stuff -->
    <script>
      // Constants of durations of match events



    </script>

    <!-- Saved Tab -->
    <script>
      var savedTabPanel = document.getElementById("nav-matches-tab");
      savedTabPanel.addEventListener('shown.bs.tab', function(event){
        populateMatchesList('savedMatchesList');

      });

    </script>

    <!-- Send Transfer Tab -->
    <script>

      var dataToTransfer = {};
      var matchesNotTransfered = {};
      var pitNotTransfered = {};
      var splitDataToTransfer = [];
      var currQrCode = 0;

      var transferTabPanel = document.getElementById("nav-transfer-tab");
      transferTabPanel.addEventListener('shown.bs.tab', function(event){
        populateTransferList('sendSavedMatchesList');
        // populateTransferPitList('sendSavedPitsList');

      });

      $('#transfer_send').click(function(){
        $('#receive-data-section').hide()
        $('#send-data-section').show()
      })
      $('#transfer_receive').click(function(){
        $('#send-data-section').hide()
        $('#receive-data-section').show()
      })

      function generateQRCodeToTransfer(){
        generateQRCode('qrCodeBlock', dataToTransfer);
      }

      function handleTransferCheckbox(ele,id){
        if($(ele).prop("checked")){
          dataToTransfer[id] = matchesNotTransfered[id];
          console.log(dataToTransfer)
        } else {
         delete dataToTransfer[id];
        }



        if(Object.keys(dataToTransfer).length > 0){
          $('#generateQrCodeBtn').prop('disabled', false);
        } else {
          $('#generateQrCodeBtn').prop('disabled', true);
        }


      }

      function backToSelectTransfer(){
        $('#generateQrCodeBackBtn').hide()
        $('#qrCodeSection').hide()
        $('#send-list-section').show()
        $('#generateQrCodeBtn').show()
        $('#doneTransferBtn').hide()

      }

      function showQRCodeForMatches(){

        $('#send-list-section').hide()
        $('#generateQrCodeBtn').hide()
        $('#generateQrCodeBackBtn').show()
        $('#qrCodeSection').show()
        $('#qrNextBtn').show();
        $('#qrPrevBtn').hide();
        currQrCode = 0;

        splitDataToTransfer = [];
        let stringifiedData = JSON.stringify(dataToTransfer);
        if(stringifiedData.length > maxQRCodeStrLen){
          let storedStrLen = 0;
          while(storedStrLen < stringifiedData.length){
            splitDataToTransfer.push(stringifiedData.slice(storedStrLen, storedStrLen+maxQRCodeStrLen));
            storedStrLen += maxQRCodeStrLen;
            //allow to click through qr codes
          }

          $('#numQrCodes').html(splitDataToTransfer.length)
          $('#numTransferInfo').show();
          $('#currentQrCode').html(1)
          generateQRCode(splitDataToTransfer[0]);
        } else {
          generateQRCode(stringifiedData);
        }

        $('#generateQrCodeBtn').prop('disabled', true);
        $('#doneTransferBtn').show()


      }

      $('#qrPrevBtn').click(function(){
        let prevQRCode = --currQrCode;
        let displayQrCode =prevQRCode+1;
        $('#currentQrCode').html(displayQrCode)
        generateQRCode(splitDataToTransfer[prevQRCode]);

        if(currQrCode == 0){
          $('#qrPrevBtn').hide();
        }
        
        $('#qrNextBtn').show();

      });
      $('#qrNextBtn').click(function(){
        let nextQRCode = ++currQrCode;
        let displayQrCode = nextQRCode+1;
        $('#currentQrCode').html(displayQrCode)
        generateQRCode(splitDataToTransfer[nextQRCode]);

        if(currQrCode == splitDataToTransfer.length-1){
          $('#qrNextBtn').hide();
        }
        
        $('#qrPrevBtn').show();


      });
      $('#doneTransferBtn').click(function(){
        if(confirm("Are you sure you're done transfering?")){
          //markMatchesAsTransfered()
          let promiseArr = Object.keys(dataToTransfer).map(function(key){
            dataToTransfer[key]['transfered'] = 1;
            return updateMatch(key, dataToTransfer[key]).then(function(res){
              
              return res;
            })
          })

          Promise.all(promiseArr).then(function(resultsArray){
            qrcode.clear();
            Object.keys(dataToTransfer).forEach(function(key){
              $('#transferMatch_' + key).remove();
            })
            dataToTransfer = [];
            $('#qrCodeBlock').html("");
            $('#doneTransferBtn').hide();
            $('#numTransferInfo').hide();
            $('#generateQrCodeBtn').prop('disabled', false);
            
            populateTransferList();
          })
        }
      });

    </script>

    <!-- QRCode Scanning -->
    <!-- https://github.com/mebjas/html5-qrcode#pro-mode---if-you-want-to-implement-your-own-user-interface -->
    <script>
      function onScanSuccess(decodedText, decodedResult) {
        // handle the scanned code as you like, for example:
        console.log(`Code matched = ${decodedText}`, decodedResult);
        html5QrcodeScanner.stop().then((ignore) => {
          // QR Code scanning is stopped.
        }).catch((err) => {
          // Stop failed, handle it.
        });
      }
      
      function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // for example:
        console.warn(`Code scan error = ${error}`);
      }
      
      //let html5QrcodeScanner = new Html5QrcodeScanner(
      //  "reader",
      //  { fps: 10, qrbox: {width: 250, height: 250} },
      //  /* verbose= */ false);
      //html5QrcodeScanner.render(onScanSuccess, onScanFailure);


      $('#initCameraScanning').click(function(){
        requestCamera();
      })

      $('#stopCameraScanning').click(function(){
        stopCamera();
      })

      // Custom code now::
      // This method will trigger user permissions
      const html5QrCode = new Html5Qrcode(/* element id */ "reader");

      function requestCamera(){
        Html5Qrcode.getCameras().then(devices => {
          /**
           * devices would be an array of objects of type:
           * { id: "id", label: "label" }
           */
          if (devices && devices.length) {
            var cameraId = devices[0].id;
            // .. use this to start scanning.

            html5QrCode.start(
              cameraId, 
              {
                fps: 10,    // Optional, frame per seconds for qr code scanning
                qrbox: { width: 250, height: 250 }  // Optional, if you want bounded box UI
              },
              (decodedText, decodedResult) => {
                // do something when code is read
              },
              (errorMessage) => {
                // parse error, ignore it.
              })
            .catch((err) => {
              // Start failed, handle it.
});
          }
        }).catch(err => {
          // handle err
        });
      }

      function stopCamera(){
        html5QrCode.stop().then((ignore) => {
          // QR Code scanning is stopped.
        }).catch((err) => {
          // Stop failed, handle it.
        });
      }


    </script>

    
    <!-- Helper Functions -->
    <script>
      var qrcode; // QRCode OBJ
      const maxQRCodeStrLen = 800;



      $().ready(function(){
        qrcode = new QRCode('qrCodeBlock',{
          height:512,
          width:512
        });
      })


      function generateQRCode(data){
        qrcode.clear(); 
        if(data.length <= 217 && data.length >= 192){data+="                          ";}
        qrcode.makeCode(data)
      }

      function populateMatchesList(eleId, showCheckboxes){
        getAllMatches().then(data =>{
          if(data.length == $("#" + eleId).children().length){return;}else{$('#'+eleId).html("")}
          let sortedData = data.sort(
            (p1, p2) => (p1.recorded_date < p2.recorded_date) ? 1 : (p1.recorded_date > p2.recorded_date) ? -1 : 0);
          data.forEach(match => {
              var divStr = '<div class="list-group-item text-align-left">' +
                  '<div class="d-flex">';

                divStr += '<div>Team ' + match.team_number + '</div>'+
                    '<div class="mx-2"> - </div>' + 
                    '<div>'+match.type+': ' + match.match_number + '</div>' +
                  '</div>'+
                  '<div class="text-secondary">'+match.date+'</div>'+ 
                  '</div>';
                $('#'  +eleId).append(divStr);
          })

        })
      }

      function populateTransferPitList(eleId){
        getAllPitsIndexed('transfered',0).then(data =>{
          if(data.length == $("#" + eleId).children().length){return;}else{$('#'+eleId).html("")}
          let sortedData = data.sort(
            (p1, p2) => (p1.recorded_date < p2.recorded_date) ? 1 : (p1.recorded_date > p2.recorded_date) ? -1 : 0);
          data.forEach(pit => {
            pitNotTransfered[pit.id] = pit;
              var divStr = '<div class="list-group-item text-align-left" id="transferMatch_'+pit.id+'">' +
                  '<div class="form-check" >'+
                    '<input class="form-check-input transferMatchCheckbox" type="checkbox" value="'+pit.id+'" onclick="handleTransferCheckbox(this, '+match.id+')">' +
                    '<label class="w-100" for="transferMatch_'+pit.id+'">'+
                      '<div class="d-flex">' +
                        '<div>Team ' + pit.team_number + '</div>'+
                      '</div>'+
                    '</label>'+
                  '</div>' +
                '</div>';
                $('#'  +eleId).append(divStr);
          })

        })
      }
      function populateTransferList(eleId){
        getAllMatchesIndexed('transfered',0).then(data =>{
          if(data.length == $("#" + eleId).children().length){return;}else{$('#'+eleId).html("")}
          let sortedData = data.sort(
            (p1, p2) => (p1.recorded_date < p2.recorded_date) ? 1 : (p1.recorded_date > p2.recorded_date) ? -1 : 0);
          data.forEach(match => {
            if($.isArray(match)){console.log(match); newMatch = Object.fromEntries(match.entries());console.log(newMatch)}
            matchesNotTransfered[match.id] = match;
            
              var divStr = '<div class="list-group-item text-align-left" id="transferMatch_'+match.id+'">' +
                  '<div class="form-check" >'+
                    '<input class="form-check-input transferMatchCheckbox" type="checkbox" value="'+match.id+'" id="matchCheck_'+match.id+'" name="matchCheck_'+match.id+'"onclick="handleTransferCheckbox(this, '+match.id+')">' +
                    '<label class="form-check-label" for="matchCheck_'+match.id+'">'+
                      '<div class="d-flex">' +
                        '<div>Team ' + match.team_number + '</div>'+
                        '<div class="mx-2"> - </div>' + 
                        '<div>'+match.type+': ' + match.match_number + '</div>' +
                      '</div>'+
                      '<div class="text-secondary">'+match.date+'</div>'+ 
                      '<div class="text-secondary">'+match.id+'</div>'+ 
                    '</label>'+
                  '</div>' +
                '</div>';
                $('#'  +eleId).append(divStr);
          })

        })
      }

    </script>

  </body>
</html>
